<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Earth Rover - Vehicle Control Station</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script type="text/javascript" src="/static/vehicle-control-station/roslib.min.js"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="/static/vehicle-control-station/vcs-styles.css">
</head>
<body>
    <div class="container">
        <!-- ============================================
             HEADER & STATUS
             ============================================ -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="margin: 0; font-size: 1.2em;">üöô Earth Rover - VCS</h1>
                <div id="ros-status" class="status-indicator status-disconnected">Disconnected</div>
            </div>
        </div>
        
        <!-- ============================================
             COMPACT AVIONICS INSTRUMENTS
             ============================================ -->
        <div class="section">
            <div class="section-title" onclick="toggleSection('instruments')">
                <span>‚öôÔ∏è Avionics Instruments</span>
                <span class="section-toggle">‚ñº</span>
            </div>
            <div id="instruments-content" class="section-content">
                <!-- Compact Control Panel -->
                <div class="control-panel" style="margin-bottom: 15px;">
                    <!-- Disk Space Widget -->
                    <div class="widget disk-space-widget">
                        <div>
                            <div class="text-muted" style="font-size: 0.75em; margin-bottom: 5px;">Storage Capacity</div>
                            <div class="disk-bar-container">
                                <div id="disk-bar" class="disk-bar low" style="width: 0%;"></div>
                            </div>
                            <div class="disk-info mt-1">
                                <div class="disk-info-item">
                                    <div class="disk-label">Used</div>
                                    <div id="disk-used" class="disk-value">--</div>
                                </div>
                                <div class="disk-info-item">
                                    <div class="disk-label">Free</div>
                                    <div id="disk-free" class="disk-value">--</div>
                                </div>
                                <div class="disk-info-item">
                                    <div class="disk-label">Total</div>
                                    <div id="disk-total" class="disk-value">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recording Controls -->
                    <div class="widget recording-controls">
                        <div class="recording-title">üìπ Rosbag Recording</div>
                        <div class="recording-buttons">
                            <button id="start-recording-btn" class="btn btn-danger" onclick="startRecording()">
                                Start Recording
                            </button>
                            <button id="stop-recording-btn" class="btn btn-secondary" onclick="stopRecording()" disabled>
                                Stop Recording
                            </button>
                            <div id="recording-status" class="recording-status idle">Idle</div>
                        </div>
                    </div>
                </div>
                
                <div class="instruments-compact">
                    <div class="instrument-mini">
                        <canvas id="attitude-mini" width="200" height="200"></canvas>
                        <div class="label">Attitude</div>
                        <div class="value" id="pitch-value">P: 0.0¬∞ R: 0.0¬∞</div>
                    </div>
                    <div class="instrument-mini">
                        <canvas id="heading-mini" width="200" height="200"></canvas>
                        <div class="label">Heading</div>
                        <div class="value" id="heading-value">0.0¬∞</div>
                    </div>
                    <div class="instrument-mini">
                        <canvas id="altitude-mini" width="200" height="200"></canvas>
                        <div class="label">Altitude</div>
                        <div class="value" id="altitude-value">0.0 m</div>
                    </div>
                    <div class="instrument-mini">
                        <canvas id="laser-mini" width="200" height="200"></canvas>
                        <div class="label">Range</div>
                        <div class="value" id="laser-value">-- m</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ============================================
             CAMERA FEEDS
             ============================================ -->
        <div class="section">
            <div class="section-title" onclick="toggleSection('cameras')">
                <span>üìπ Camera Feeds</span>
                <span class="section-toggle">‚ñº</span>
            </div>
            <div id="cameras-content" class="section-content">
                <div class="grid grid-compact">
                    <!-- Left Stereo Camera -->
                    <div class="card camera-card">
                        <h2>Left Stereo Camera</h2>
                        <div class="camera-controls">
                            <button class="camera-btn" onclick="toggleCamera('left-stereo')">‚ñ∂ Play</button>
                            <select id="left-stereo-quality" onchange="updateCameraQuality('left-stereo')" style="font-size: 0.75em; padding: 4px;">
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="low">Low</option>
                                <option value="snapshot">Snapshot</option>
                            </select>
                        </div>
                        <div id="left-stereo-container" class="camera-container">
                            <div class="camera-placeholder" onclick="startCamera('left-stereo')">
                                <div class="camera-placeholder-icon">üì∑</div>
                                <div>Click to Start</div>
                            </div>
                        </div>
                        <div id="left-stereo-status" class="camera-status paused">Paused</div>
                    </div>
                    
                    <!-- Right Stereo Camera -->
                    <div class="card camera-card">
                        <h2>Right Stereo Camera</h2>
                        <div class="camera-controls">
                            <button class="camera-btn" onclick="toggleCamera('right-stereo')">‚ñ∂ Play</button>
                            <select id="right-stereo-quality" onchange="updateCameraQuality('right-stereo')" style="font-size: 0.75em; padding: 4px;">
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="low">Low</option>
                                <option value="snapshot">Snapshot</option>
                            </select>
                        </div>
                        <div id="right-stereo-container" class="camera-container">
                            <div class="camera-placeholder" onclick="startCamera('right-stereo')">
                                <div class="camera-placeholder-icon">üì∑</div>
                                <div>Click to Start</div>
                            </div>
                        </div>
                        <div id="right-stereo-status" class="camera-status paused">Paused</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ============================================
             ADS-B AIRCRAFT TRACKING
             ============================================ -->
        <div class="section">
            <div class="section-title" onclick="toggleSection('aircraft')">
                <span>
                    <span style="margin-right: 4px;">&#9992;</span> ADS-B Aircraft Tracking
                    <span id="aircraft-count-badge" style="background: rgba(74, 158, 255, 0.2); color: #4a9eff; padding: 2px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 700; margin-left: 8px;">0</span>
                </span>
                <span class="section-toggle">&#9660;</span>
            </div>
            <div id="aircraft-content" class="section-content">
                <div class="grid grid-compact" style="grid-template-columns: 1fr 1fr;">
                    <!-- Unified Map (rover + aircraft) -->
                    <div class="card">
                        <h2>Situational Awareness Map</h2>
                        <div id="aircraft-map" style="height: 450px; width: 100%; border-radius: 4px; border: 1px solid var(--border-color);"></div>
                        <div class="text-muted mt-1" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px;">
                            <span>
                                <span style="color: #00e676;">&#9679;</span> Rover:
                                <span id="rover-position-display" style="color: #b0b0b0;">--</span>
                            </span>
                            <span>
                                <span style="color: #00e5ff;">&#9992;</span> Aircraft: <span id="aircraft-map-count" style="color: #4a9eff; font-weight: 600;">0</span>
                            </span>
                            <span>1090 MHz | RTL-SDR V4</span>
                        </div>
                    </div>

                    <!-- Aircraft List -->
                    <div class="card">
                        <h2>Tracked Aircraft</h2>
                        <div id="aircraft-list-container" style="max-height: 450px; overflow-y: auto; font-size: 0.8em;">
                            <div class="text-center text-muted" style="padding: 40px 0;">
                                Waiting for ADS-B data...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             SENSOR DATA
             ============================================ -->
        <div class="section">
            <div class="section-title" onclick="toggleSection('sensors')">
                <span>üìä Sensor Data</span>
                <span class="section-toggle">‚ñº</span>
            </div>
            <div id="sensors-content" class="section-content">
                <div class="grid grid-compact">
                    <!-- Laser Scan -->
                    <div class="card">
                        <h2>2D Laser Scan</h2>
                        <canvas id="laserscan-canvas" class="canvas-container"></canvas>
                        <div class="text-muted mt-1">
                            Points: <span id="laserscan-points">0</span> | 
                            Range: <span id="laserscan-range">0.0</span> m
                        </div>
                    </div>
                    
                    <!-- Spectrometer -->
                    <div class="card camera-card">
                        <h2>Spectrometer</h2>
                        <div class="camera-controls">
                            <button class="camera-btn" onclick="toggleCamera('spectrometer-plot')">‚ñ∂ Play</button>
                            <select id="spectrometer-plot-quality" onchange="updateCameraQuality('spectrometer-plot')" style="font-size: 0.75em; padding: 4px;">
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="low">Low</option>
                                <option value="snapshot">Snapshot</option>
                            </select>
                        </div>
                        <div id="spectrometer-plot-container" class="camera-container">
                            <div class="camera-placeholder" onclick="startCamera('spectrometer-plot')">
                                <div class="camera-placeholder-icon">üìä</div>
                                <div>Click to Start</div>
                            </div>
                        </div>
                        <div id="spectrometer-plot-status" class="camera-status paused">Paused</div>
                    </div>
                    
                    <!-- Velodyne 3D Point Cloud -->
                    <div class="card">
                        <h2>üéØ Velodyne 3D Point Cloud</h2>
                        <div id="velodyne-container">
                            <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 8px; border-radius: 4px; color: white; font-size: 0.75em; z-index: 10;">
                                <div>Points: <span id="velodyne-points">0</span></div>
                                <div>Frame: <span id="velodyne-frame">-</span></div>
                                <button class="btn btn-primary" style="margin-top: 5px; padding: 4px 8px; font-size: 0.75em;" onclick="resetVelodyneView()">Reset View</button>
                                <button class="btn btn-primary" style="margin-top: 5px; padding: 4px 8px; font-size: 0.75em;" onclick="toggleVelodyneAutoRotate()">
                                    Auto: <span id="auto-rotate-status">Off</span>
                                </button>
                            </div>
                        </div>
                        <div class="text-muted mt-1 text-center">
                            Use mouse to rotate, scroll to zoom, right-click to pan
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ============================================
             ROS DIAGNOSTICS (COMPACT)
             ============================================ -->
        <div class="section">
            <div class="section-title" onclick="toggleSection('diagnostics')">
                <span>ü§ñ ROS Diagnostics</span>
                <span class="section-toggle">‚ñº</span>
            </div>
            <div id="diagnostics-content" class="section-content">
                <div class="ros-diagnostics-compact">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <!-- Nodes Column -->
                        <div style="flex: 1; min-width: 300px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(74, 158, 255, 0.1); border-left: 3px solid #4a9eff; margin-bottom: 8px;">
                                <span style="font-weight: 600; color: #4a9eff;">Active Nodes</span>
                                <span id="ros-nodes-count" style="background: rgba(74, 158, 255, 0.2); color: #4a9eff; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 700;">0</span>
                            </div>
                            <div id="ros-nodes-container" style="max-height: 200px; overflow-y: auto; font-size: 0.75em; line-height: 1.6;">
                                <div class="text-center text-muted">Loading...</div>
                            </div>
                        </div>
                        
                        <!-- Topics Column -->
                        <div style="flex: 1; min-width: 300px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(74, 158, 255, 0.1); border-left: 3px solid #4a9eff; margin-bottom: 8px;">
                                <span style="font-weight: 600; color: #4a9eff;">Active Topics</span>
                                <span id="ros-topics-count" style="background: rgba(74, 158, 255, 0.2); color: #4a9eff; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 700;">0</span>
                            </div>
                            <div id="ros-topics-container" style="max-height: 200px; overflow-y: auto; font-size: 0.75em; line-height: 1.6;">
                                <div class="text-center text-muted">Loading...</div>
                            </div>
                        </div>
                        
                        <!-- Version Info -->
                        <div style="width: 100%; padding: 8px 12px; background: rgba(0, 0, 0, 0.2); border-radius: 4px; text-align: center;">
                            <span id="ros-version-display" class="text-muted" style="font-size: 0.85em;">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- JavaScript Configuration (from Django) -->
    <script>
        // Configuration passed from backend with environment variables
        window.VCS_BACKEND_CONFIG = {
            rosbridge_url: '{{ ros_bridge_url }}',
            video_server_url: '{{ video_server_url }}'
        };
    </script>
    
    <!-- JavaScript -->
    <script src="/static/vehicle-control-station/vcs-app.js"></script>
</body>
</html>

